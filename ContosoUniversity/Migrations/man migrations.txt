https://docs.microsoft.com/ru-ru/aspnet/core/data/ef-rp/migrations?view=aspnetcore-2.2&tabs=visual-studio

Razor Pages с EF Core в ASP.NET Core — миграции — 4 из 8
01.07.2017
Время чтения: 4 мин
Соавторы
Rick Anderson  olprod
Авторы: Том Дайкстра (Tom Dykstra), Йон П. Смит (Jon P Smith) и Рик Андерсон (Rick Anderson)
Веб-приложение университета Contoso демонстрирует создание веб-приложений Razor Pages с использованием EF Core и Visual Studio. Сведения о серии руководств см. в первом руководстве серии.
В этом учебнике используется функция миграций EF Core для управления изменениями модели данных.
При возникновении проблем, которые вам не удается устранить, скачайте готовое приложение.
При разработке нового приложения модель данных часто изменяется. При каждом изменении нарушается синхронизация модели с базой данных. Вы начали работу с этим учебником, настроив платформу Entity Framework для создания базы данных, если она еще не существует. Каждый раз при изменении модели данных:
База данных удаляется.
Платформа EF создает новую базу данных, соответствующую модели.
Приложение заполняет базу тестовыми данными.
Этот подход к обеспечению синхронизации базы данных с моделью данных хорошо работает до развертывания приложения в рабочей среде. Приложение, выполняющееся в рабочей среде, обычно содержит данные. Приложение не может запускаться с тестовой базой данных каждый раз при внесении изменений (например, при добавлении столбца). Функция миграций EF Core решает эту проблему, позволяя платформе EF Core обновить схему базы данных вместо создания новой базы.
Вместо удаления и повторного создания базы данных при изменении модели функция миграций обновляет схему, сохраняя существующие данные.
Удаление базы данных
Воспользуйтесь обозревателем объектов SQL Server (SSOX) или командой database drop:
Visual Studio
Интерфейс командной строки .NET Core
Выполните следующие команды в консоли диспетчера пакетов (PMC):
PMC

Копировать
Drop-Database
Чтобы просмотреть справочную информацию, выполните команду Get-Help about_EntityFrameworkCore в PMC.
Создание первоначальной миграции и обновление базы данных
Выполните построение проекта и создайте первую миграцию.
Visual Studio
Интерфейс командной строки .NET Core
PMC

Копировать
Add-Migration InitialCreate
Update-Database
Обзор методов Up и Down
Команда EF Core migrations add создала код для создания базы данных. Код миграции находится в файле Migrations<метка_времени>_InitialCreate.cs. Метод Up класса InitialCreate создает таблицы базы данных, соответствующие наборам сущностей модели данных. Метод Down удаляет их, как показано в следующем примере:
C#

Копировать
public partial class InitialCreate : Migration
{
    protected override void Up(MigrationBuilder migrationBuilder)
    {
        migrationBuilder.CreateTable(
            name: "Course",
            columns: table => new
            {
                CourseID = table.Column<int>(nullable: false),
                Title = table.Column<string>(nullable: true),
                Credits = table.Column<int>(nullable: false)
            },
            constraints: table =>
            {
                table.PrimaryKey("PK_Course", x => x.CourseID);
            });

        migrationBuilder.CreateTable(
    protected override void Down(MigrationBuilder migrationBuilder)
    {
        migrationBuilder.DropTable(
            name: "Enrollment");

        migrationBuilder.DropTable(
            name: "Course");

        migrationBuilder.DropTable(
            name: "Student");
    }
}
Функция миграций вызывает метод Up, чтобы реализовать изменения модели данных для миграции. При вводе команды для отката обновления функция миграций вызывает метод Down.
Приведенный выше код предназначен для первоначальной миграции. Этот код был создан при выполнении команды migrations add InitialCreate. Параметр имени миграции (в примере это "InitialCreate") используется в качестве имени файла. В качестве имени миграции можно использовать любое допустимое имя файла. Рекомендуется выбрать слово или фразу, которые кратко описывают назначение миграции. Например, миграция, обеспечивающая добавление таблицы кафедр, может называться "AddDepartmentTable".
Если создается первоначальная миграция и база данных существует:
Формируется код создания базы данных.
Выполнять код создания базы данных не нужно, поскольку база уже соответствует модели данных. В случае выполнения код создания базы данных не вносит никаких изменений, поскольку база уже соответствует модели данных.
При развертывании приложения в новой среде этот код необходимо выполнить для создания новой базы данных.
Предыдущая база данных была удалена и не существует, поэтому функция миграций создает новую базу данных.
Моментальный снимок модели данных
Функция миграций создает моментальный снимок текущей схемы базы данных в Migrations/SchoolContextModelSnapshot.cs. При добавлении миграции EF определяет, что именно изменилось, сравнивая модель данных с файлом моментального снимка.
Чтобы удалить миграцию, выполните следующую команду:
Visual Studio
Интерфейс командной строки .NET Core
Remove-Migration
Команда remove migrations удаляет миграцию и гарантирует корректный сброс моментального снимка.
Удаление EnsureCreated и тестирование приложения
Для ранней разработки использовалась команда EnsureCreated. В этом учебнике используются миграции. EnsureCreated имеет следующие ограничения:
Пропускает миграции и создает базу данных и схему.
Не создает таблицу миграций.
Не может использоваться с миграциями.
Разработана для тестирования или быстрого создания прототипов, когда часто требуется удаление и повторное создание базы данных.
Удалите EnsureCreated:
C#

Копировать
context.Database.EnsureCreated();
Запустите приложение и убедитесь, что база заполняется данными.
Проверка базы данных
Используйте обозреватель объектов SQL Server для проверки базы данных. Обратите внимание на добавление таблицы __EFMigrationsHistory. Таблица __EFMigrationsHistory используется для отслеживания миграций, которые были применены к базе данных. Просмотрев данные в таблице __EFMigrationsHistory, вы увидите одну строку для первой миграции. Последний журнал в предыдущем примере выходных данных интерфейса командной строки показывает инструкцию INSERT, создающую эту строку.
Запустите приложение и убедитесь, что все функции работают.
Применение миграций в рабочей среде
Для рабочих приложений не рекомендуется вызывать Database.Migrate при запуске приложения. Migrate не следует вызывать из приложения в ферме серверов. Например, если приложение было развернуто в облаке с горизонтальным масштабированием (выполняется несколько экземпляров приложения).
Миграция базы данных должна выполняться контролируемым способом в рамках развертывания. Подход к миграции рабочей базы данных включает следующее:
Использование миграций для создания сценариев SQL и их использования в развертывании.
Выполнение dotnet ef database update из контролируемой среды.
Платформа EF Core использует таблицу __MigrationsHistory для определения необходимости выполнить какие-либо миграции. Если база данных находится в актуальном состоянии, миграция не выполняется.